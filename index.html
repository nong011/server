<!DOCTYPE html>
<html lang="th">
<head>
<!--
üì¶ Version: v2.0-DigitalFridge-NoLogo
üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: 2025-07-17
üë§ ‡∏ú‡∏π‡πâ‡∏û‡∏±‡∏í‡∏ô‡∏≤: Dr. Krairat Komdee (‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÇ‡∏î‡∏¢ Friday)

-->

  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="refresh" content="60">
  <title>Server Temp/Humidity/WaterLeak Monitor</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai+Rounded:wght@400;700&display=swap" rel="stylesheet">
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

  <style>
    body {
      font-family: 'Noto Sans Thai Rounded', sans-serif;
      background-color: #f6f1fb;
      margin: 0;
      padding: 2rem;
      color: #4a4a4a;
    }
    .container {
      background-color: #ffffff;
      max-width: 960px;
      margin: auto;
      padding: 2rem;
      border-radius: 20px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.08);
    }
    img {
      max-width: 100%;
      height: auto;
    }
    .footer {
      text-align: center;
      margin-top: 2rem;
      font-size: 0.9rem;
      color: #999;
    }
    .timestamp {
      text-align: center;
      font-size: 1rem;
      margin-bottom: 0.3rem;
      color: #7c3aed;
    }
    .range-buttons {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 0.5rem;
      margin-bottom: 1.5rem;
    }
    .range-buttons button {
      background-color: #f3e8ff;
      border: none;
      border-radius: 1rem;
      padding: 0.5rem 1.2rem;
      font-size: 1rem;
      color: #6b21a8;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
    }
    .range-buttons button.active,
    .range-buttons button:hover {
      background-color: #d8b4fe;
      font-weight: bold;
    }
    .gauges {
      display: flex;
      justify-content: space-around;
      flex-wrap: wrap;
      gap: 2rem;
      margin-bottom: 2rem;
    }
    .gauge-wrapper {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 1rem;
      border-radius: 20px;
      background-color: #fff;
      box-shadow: 0 4px 10px rgba(0,0,0,0.05);
      flex: 1; /* Make gauges flex evenly */
      min-width: 280px; /* Ensure minimum width for smaller screens */
    }
    .gauge-title {
      font-size: 1.1rem;
      font-weight: bold;
      color: #6b21a8;
      margin-bottom: 0.5rem;
    }
    .gauge-time {
      margin-top: 0.5rem;
      font-size: 0.9rem;
      color: #444;
    }
    .alert {
      filter: brightness(1.1); /* Slightly brighter for alert */
      background-color: #ffeaea !important; /* Override background for alert */
      border: 2px solid #ff5c5c;
    }
    .offline {
      filter: grayscale(0.5); /* Dim for offline */
    }
    @media screen and (max-width: 768px) {
      body {
        padding: 1rem;
      }
      .container {
        padding: 1rem;
      }
      .range-buttons button {
        font-size: 0.9rem;
        padding: 0.4rem 1rem;
      }
      .gauge-wrapper {
        width: 100%;
        flex-basis: auto; /* Allow items to stack */
      }
    }
  </style>
</head>
<body>
  <div style="text-align:center; margin-bottom: 1rem;">
    <img src="https://phayaohospital.moph.go.th/assets/images/logonew.png" alt="Phayao Hospital Logo" style="max-width: 1030px; width: 100%; height: auto; object-fit: contain;">
  </div>
  <div class="container">
    <h1 style="text-align:center; color:#7e5bef">DashBoard Temperature and Humidity @Server Room Phayao Hospital</h1>
    <div class="timestamp" id="realtime_clock">Loading time...</div>
    <div class="timestamp" id="latest_time"></div>

    <div class="gauges" id="gauges_section"></div>

    <div class="range-buttons">
      <button onclick="updateChart(1, event)" class="active">‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á</button>
      <button onclick="updateChart(24, event)">‡∏ß‡∏±‡∏ô</button>
      <button onclick="updateChart(168, event)">‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå</button>
      <button onclick="updateChart(720, event)">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</button>
    </div>

    <div id="chart_div" style="width: 100%; height: 400px;"></div>
    <div id="humidity_chart" style="width: 100%; height: 400px;"></div>

    <div style="text-align: center; margin-top: 1rem;">
      <label for="serverSelect">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á:</label>
      <select id="serverSelect"></select>
      <label for="monthSelect">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô:</label>
      <select id="monthSelect"></select>
      <button onclick="exportMonthlyPDF()" style="background-color: #c084fc; color: white; padding: 0.6rem 1.5rem; border: none; border-radius: 10px; font-size: 1rem; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
        üìÑ Export ‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÄ‡∏õ‡πá‡∏ô PDF
      </button>
    </div>
    <div class="footer">¬© 2025 ‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥ ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô By... Krairat Komdee, MD.</div>
  </div>
<script>
const SHEET_ID = '1bdzraltDO3EhQxMEAKAyuqCRWRm5RRMpXfe_mr96kkk';
// ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Server ‡πÅ‡∏•‡∏∞‡∏™‡∏µ‡πÉ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏î‡∏µ‡∏¢‡∏ß ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏∑‡∏î‡∏´‡∏¢‡∏∏‡πà‡∏ô
const SERVER_CONFIGS = [
    { name: 'Server1', displayName: 'ServerRoom @6th Fl OPD', color: '#FFB6D9', tempMin: 18, tempMax: 27 }, // Temp range for Server room
    { name: 'Server2', displayName: 'ServerRoom @DR site', color: '#BED599', tempMin: 18, tempMax: 27 },
    { name: 'Server3', displayName: 'ServerRoom @3rd Fl ER', color: '#FFF9B0', tempMin: 18, tempMax: 27 }
];

let fullDataBySheet = {};
let currentRange = 1; // Default to 1 hour
const OFFLINE_THRESHOLD_MINUTES = 6; // Device is considered offline if last update is older than this (in minutes)

// Static image URLs to embed directly or manage centrally if not too many
const IMAGE_URLS = {
    online: 'https://img2.pic.in.th/pic/ChatGPT-Image-Jul-17-2025-09_42_41-PM.png',
    outOfRange: 'https://img5.pic.in.th/file/secure-sv1/ChatGPT-Image-Jul-17-2025-09_38_28-PM.png',
    offline: 'https://img5.pic.in.th/file/secure-sv1/ChatGPT-Image-Jul-17-2025-09_45_15-PM.png'
};

// Function to safely parse float values, returning null if invalid
function safeParseFloat(value) {
    const parsed = parseFloat(value);
    return isNaN(parsed) ? null : parsed;
}

// Function to parse date strings in DD/MM/YYYY HH:mm:ss format
function parseDateDDMMYYYY(str) {
    if (!str) return null;
    const parts = str.match(/(\d{2})\/(\d{2})\/(\d{4}) (\d{2}):(\d{2}):(\d{2})/);
    if (!parts) return null;
    const [, day, month, year, hour, minute, second] = parts;
    return new Date(year, month - 1, day, hour, minute, second);
}

// Function to fetch data from Google Sheets (using Public CSV endpoint for simplicity and robustness)
async function fetchSheetData(sheetName) {
    try {
        const response = await fetch(`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${sheetName}`);
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        const text = await response.text();
        const jsonString = text.substring(text.indexOf('{'), text.lastIndexOf('}') + 1);
        const json = JSON.parse(jsonString);

        const data = json.table.rows.map(row => {
            const timeStr = row.c[0]?.f || row.c[0]?.v;
            return {
                time: parseDateDDMMYYYY(timeStr),
                temp: safeParseFloat(row.c[1]?.v),
                hum: safeParseFloat(row.c[2]?.v)
            };
        }).filter(d => d.time); // Filter out rows with invalid dates
        return data;
    } catch (error) {
        console.error(`Error fetching data for sheet ${sheetName}:`, error);
        return []; // Return empty array on error
    }
}

// Fetch all sheets' data
async function fetchAllSheets() {
    fullDataBySheet = {};
    const fetchPromises = SERVER_CONFIGS.map(async config => {
        const data = await fetchSheetData(config.name);
        fullDataBySheet[config.name] = data;
    });
    await Promise.all(fetchPromises);
    document.getElementById("latest_time").innerText = '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ' + new Date().toLocaleString('th-TH');
}

// Draw gauge cards for each server
function drawGauges() {
    const gaugeContainer = document.getElementById('gauges_section');
    gaugeContainer.innerHTML = ''; // Clear previous gauges

    SERVER_CONFIGS.forEach(config => {
        const sheetName = config.name;
        const displayName = config.displayName; // ‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
        const last = fullDataBySheet[sheetName]?.at(-1);

        // Handle cases where data might not be available or is old
        if (!last || !last.time || last.temp === null || last.hum === null) { // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö null ‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô
            console.warn(`No valid latest data for ${displayName}. Skipping gauge creation.`);
            const wrapper = document.createElement('div');
            wrapper.className = 'gauge-wrapper offline';
            wrapper.style.backgroundColor = config.color;
            wrapper.innerHTML = `
                <div style="display: flex; gap: 1rem; align-items: center;">
                    <img src="${IMAGE_URLS.offline}" alt="offline" style="width: 80px; height: auto;">
                    <div style="text-align: left; font-size: 0.95rem;">
                        <div><strong>${displayName}</strong> <span style="color:red">Offline / No Data</span></div>
                        <div>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î ‡∏´‡∏£‡∏∑‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå</div>
                    </div>
                </div>
            `;
            gaugeContainer.appendChild(wrapper);
            return; // Skip to next server if data is invalid
        }

        const timeDiffMinutes = (new Date() - last.time) / (1000 * 60);
        const isOffline = timeDiffMinutes > OFFLINE_THRESHOLD_MINUTES;
        const isOutOfRange = last.temp < config.tempMin || last.temp > config.tempMax;

        let imageUrl = IMAGE_URLS.online;
        let onlineStatusText = '<span style="color:green">Online</span>';
        let additionalClass = '';

        if (isOffline) {
            imageUrl = IMAGE_URLS.offline;
            onlineStatusText = '<span style="color:red">Offline</span>';
            additionalClass = 'offline';
        } else if (isOutOfRange) {
            imageUrl = IMAGE_URLS.outOfRange;
            additionalClass = 'alert';
        }

        const wrapper = document.createElement('div');
        wrapper.className = `gauge-wrapper ${additionalClass}`;
        wrapper.style.backgroundColor = config.color; // Set individual background color

        wrapper.innerHTML = `
            <div style="display: flex; gap: 1rem; align-items: center;">
                <img src="${imageUrl}" alt="status icon" style="width: 80px; height: auto;">
                <div style="text-align: left; font-size: 0.95rem;">
                    <div><strong>${displayName}</strong> ${onlineStatusText}</div>
                    <div>üìÖ Time: ${last.time.toLocaleString('th-TH')}</div>
                    <div>üå°Ô∏è Temp: ${last.temp.toFixed(1)}¬∞C</div>
                    <div>üíß Humid: ${last.hum.toFixed(1)}%</div>
                </div>
            </div>
        `;
        gaugeContainer.appendChild(wrapper);
    });
}

// Function to draw combined temperature chart
function drawCombinedChart() {
    const now = new Date();
    const start = new Date(now.getTime() - currentRange * 60 * 60 * 1000);
    const timestamps = new Set();
    const alignedData = {};

    SERVER_CONFIGS.forEach(config => {
        alignedData[config.name] = fullDataBySheet[config.name]?.filter(d => d.time >= start && d.temp !== null) || [];
        alignedData[config.name].forEach(d => timestamps.add(d.time.getTime()));
    });

    const uniqueTimes = Array.from(timestamps).sort().map(t => new Date(parseInt(t)));
    const chartArray = [['Time', ...SERVER_CONFIGS.map(s => s.displayName)]]; // ‡πÉ‡∏ä‡πâ displayName ‡πÉ‡∏ô‡∏´‡∏±‡∏ß‡∏Å‡∏£‡∏≤‡∏ü

    uniqueTimes.forEach(time => {
        const row = [time];
        SERVER_CONFIGS.forEach(config => {
            const point = alignedData[config.name].find(d => d.time.getTime() === time.getTime());
            row.push(point ? point.temp : null);
        });
        chartArray.push(row);
    });

    // Ensure there's at least one data point for the chart to render
    if (chartArray.length <= 1) {
        document.getElementById('chart_div').innerHTML = '<div style="text-align:center; padding:20px; color:#999;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</div>';
        return;
    }

    const data = google.visualization.arrayToDataTable(chartArray);
    const options = {
        title: `‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á ${currentRange} ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á`,
        hAxis: { title: '‡πÄ‡∏ß‡∏•‡∏≤', format: 'dd/MM HH:mm' },
        vAxis: { title: '‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥ (¬∞C)' },
        lineWidth: 2,
        pointSize: 4,
        legend: { position: 'bottom' },
        colors: SERVER_CONFIGS.map(s => s.color), // Use configured colors
        animation: {startup: true, duration: 1000, easing: 'out'},
        explorer: {
            actions: ['dragToZoom', 'rightClickToReset'],
            axis: 'horizontal',
            keepInBounds: true,
            maxZoomIn: 4.0
        }
    };
    new google.visualization.LineChart(document.getElementById('chart_div')).draw(data, options);
}

// Function to draw humidity chart
function drawHumidityChart() {
    const now = new Date();
    const start = new Date(now.getTime() - currentRange * 60 * 60 * 1000);
    const timestamps = new Set();
    const alignedData = {};

    SERVER_CONFIGS.forEach(config => {
        alignedData[config.name] = fullDataBySheet[config.name]?.filter(d => d.time >= start && d.hum !== null) || [];
        alignedData[config.name].forEach(d => timestamps.add(d.time.getTime()));
    });

    const uniqueTimes = Array.from(timestamps).sort().map(t => new Date(parseInt(t)));
    const chartArray = [['Time', ...SERVER_CONFIGS.map(s => s.displayName)]]; // ‡πÉ‡∏ä‡πâ displayName ‡πÉ‡∏ô‡∏´‡∏±‡∏ß‡∏Å‡∏£‡∏≤‡∏ü

    uniqueTimes.forEach(time => {
        const row = [time];
        SERVER_CONFIGS.forEach(config => {
            const point = alignedData[config.name].find(d => d.time.getTime() === time.getTime());
            row.push(point ? point.hum : null);
        });
        chartArray.push(row);
    });

    // Ensure there's at least one data point for the chart to render
    if (chartArray.length <= 1) {
        document.getElementById('humidity_chart').innerHTML = '<div style="text-align:center; padding:20px; color:#999;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</div>';
        return;
    }

    const data = google.visualization.arrayToDataTable(chartArray);
    const options = {
        title: `‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á ${currentRange} ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á`,
        hAxis: { title: '‡πÄ‡∏ß‡∏•‡∏≤', format: 'dd/MM HH:mm' },
        vAxis: { title: '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô (%)' },
        lineWidth: 2,
        pointSize: 4,
        legend: { position: 'bottom' },
        colors: SERVER_CONFIGS.map(s => { /* Slightly different colors for humidity if desired */
            // ‡πÉ‡∏ä‡πâ‡∏™‡∏µ‡πÄ‡∏î‡∏¥‡∏° ‡∏´‡∏£‡∏∑‡∏≠‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏á‡πÑ‡∏î‡πâ‡∏ï‡∏≤‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£
            if (s.name === 'Server1') return '#FFB6B9';
            if (s.name === 'Server2') return '#A5D8FF';
            if (s.name === 'Server3') return '#C3FBA6';
            return '#D3D3D3'; // Default fallback
        }),
        animation: {startup: true, duration: 1000, easing: 'out'},
        explorer: {
            actions: ['dragToZoom', 'rightClickToReset'],
            axis: 'horizontal',
            keepInBounds: true,
            maxZoomIn: 4.0
        }
    };
    new google.visualization.LineChart(document.getElementById('humidity_chart')).draw(data, options);
}

// Update chart range and redraw
function updateChart(range, event) {
    currentRange = range;
    document.querySelectorAll('.range-buttons button').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    drawCombinedChart();
    drawHumidityChart();
}

// Real-time clock update
function updateClock() {
    const now = new Date();
    document.getElementById("realtime_clock").innerText = `‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: ${now.toLocaleString('th-TH', {
        weekday: 'long', year: 'numeric', month: 'long', day: 'numeric',
        hour: '2-digit', minute:'2-digit', second:'2-digit', hour12: false
    })}`;
}

// Populate server dropdown
function populateServerSelect() {
    const serverSelect = document.getElementById('serverSelect');
    // ‡πÉ‡∏ä‡πâ displayName ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÉ‡∏ô dropdown
    serverSelect.innerHTML = SERVER_CONFIGS.map(config => `<option value="${config.name}">${config.displayName}</option>`).join('');
}

// Populate month dropdown
function populateMonthSelect() {
    const monthSelect = document.getElementById('monthSelect');
    const monthNames = [
        "‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°", "‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå", "‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°", "‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô", "‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°", "‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô",
        "‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°", "‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°", "‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô", "‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°", "‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô", "‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°"
    ];
    monthSelect.innerHTML = monthNames.map((name, index) => `<option value="${index}">${name}</option>`).join('');
    // Set current month as default
    monthSelect.value = new Date().getMonth();
}

// Initialization function
async function init() {
    populateServerSelect();
    populateMonthSelect();
    await fetchAllSheets();
    drawGauges();
    drawCombinedChart();
    drawHumidityChart();

    // Set interval for data refresh (every 5 minutes)
    setInterval(async () => {
        await fetchAllSheets();
        drawGauges();
        drawCombinedChart();
        drawHumidityChart();
    }, 300000); // 300000 ms = 5 minutes

    // Set interval for real-time clock (every 1 second)
    setInterval(updateClock, 1000);
    updateClock(); // Initial clock update
}

// Load Google Charts and then call init
google.charts.load('current', {'packages':['corechart', 'gauge']});
google.charts.setOnLoadCallback(init);
</script>

<!-- Add html2canvas and jspdf libraries for better PDF export -->
<!-- IMPORTANT: Ensure these scripts are loaded BEFORE your custom script that uses them -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>


<script>
async function exportMonthlyPDF() {
    console.log("1. exportMonthlyPDF function called.");
    try {
        const serverId = document.getElementById('serverSelect').value;
        const selectedServerConfig = SERVER_CONFIGS.find(config => config.name === serverId);
        const serverDisplayName = selectedServerConfig ? selectedServerConfig.displayName : serverId;

        const monthSelect = document.getElementById('monthSelect');
        const month = parseInt(monthSelect.value);
        const monthName = monthSelect.options[month].text;
        const year = new Date().getFullYear();

        const data = (fullDataBySheet[serverId] || []).filter(d => d.time && d.time.getMonth() === month && d.time.getFullYear() === year);

        if (data.length === 0) {
            alert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÅ‡∏•‡∏∞‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å');
            console.warn('No data for selected month and server.');
            return;
        }
        console.log("2. Data filtered and available.");

        const chartArray = [['Time', '‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥ (¬∞C)', '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô (%)']];
        data.forEach(d => chartArray.push([d.time, d.temp, d.hum]));

        // Temporarily create a hidden div to render the chart for PDF export
        const tempDiv = document.createElement('div');
        tempDiv.id = 'tempChartDiv'; // Added ID for easier removal
        tempDiv.style.width = '1000px';
        tempDiv.style.height = '600px';
        tempDiv.style.position = 'absolute';
        tempDiv.style.left = '-9999px';
        tempDiv.style.background = '#ffffff'; // Ensure background is white for capture
        document.body.appendChild(tempDiv);
        console.log("3. tempDiv created and appended.");

        // Draw the chart in the hidden div
        const googleData = google.visualization.arrayToDataTable(chartArray);
        const options = {
            title: `‡∏Å‡∏£‡∏≤‡∏ü‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥ ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô : ${serverDisplayName} ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ${monthName} ‡∏õ‡∏µ ${year}`,
            hAxis: { title: '‡πÄ‡∏ß‡∏•‡∏≤', format: 'dd/MM HH:mm' },
            vAxis: { title: '‡∏Ñ‡πà‡∏≤' },
            series: {
                0: { targetAxisIndex: 0, color: '#fb923c' },
                1: { targetAxisIndex: 1, color: '#60a5fa' }
            },
            vAxes: {
                0: { title: '‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥ (¬∞C)' },
                1: { title: '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô (%)', maxValue: 100 }
            },
            lineWidth: 2,
            pointSize: 3,
            legend: { position: 'bottom' },
            animation: { startup: true, duration: 500, easing: 'out' }
        };

        const chart = new google.visualization.LineChart(tempDiv);

        // Always draw the chart and wait for the 'ready' event
        await new Promise(resolve => {
            google.visualization.events.addListener(chart, 'ready', resolve);
            chart.draw(googleData, options);
        });
        console.log("4. Google Chart drawn and ready.");

        // Add a small delay to ensure rendering is complete
        await new Promise(resolve => setTimeout(resolve, 100)); // 100ms delay
        console.log("5. Small delay completed.");

        // Capture the chart as an image
        const canvas = await html2canvas(tempDiv, { scale: 2 });
        const imgData = canvas.toDataURL('image/png');
        console.log("6. html2canvas captured image.");

        // Clean up the temporary div
        document.body.removeChild(tempDiv);
        console.log("7. tempDiv removed.");

        // Generate PDF
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF('p', 'mm', 'a4');

        const pdfWidth = pdf.internal.pageSize.getWidth();
        // const pdfHeight = pdf.internal.pageSize.getHeight(); // ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡πâ‡∏ß

        // // ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏•‡πÇ‡∏Å‡πâ‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡πÑ‡∏õ
        // const logoImg = new Image();
        // logoImg.src = 'https://phayaohospital.moph.go.th/assets/images/logonew.png'; // ‡∏´‡∏£‡∏∑‡∏≠ 'logonew.png' ‡∏´‡∏≤‡∏Å‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏°‡∏≤
        // await new Promise(resolve => { logoImg.onload = () => resolve(); logoImg.onerror = () => { console.error("Failed to load logo image."); resolve(); }; });
        // const logoWidth = 40;
        // const logoHeight = logoImg.complete && logoImg.naturalWidth !== 0 ? logoImg.height * (logoWidth / logoImg.width) : 0;
        // if (logoHeight > 0) {
        //     pdf.addImage(logoImg, 'PNG', (pdfWidth - logoWidth) / 2, 10, logoWidth, logoHeight);
        // }
        console.log("8. Logo section skipped (removed)."); // Added log for clarity

        // Add title - ‡∏õ‡∏£‡∏±‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á Y ‡∏Ç‡∏∂‡πâ‡∏ô‡∏°‡∏≤
        let currentY = 20; // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ó‡∏µ‡πà 20mm ‡∏à‡∏≤‡∏Å‡∏Ç‡∏≠‡∏ö‡∏ö‡∏ô
        pdf.setFont('Noto Sans Thai Rounded', 'normal');
        pdf.setFontSize(16);
        pdf.text(`‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô ${serverDisplayName}`, pdfWidth / 2, currentY, { align: 'center' });
        currentY += 10; // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á
        pdf.text(`‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ${monthName} ‡∏õ‡∏µ ${year}`, pdfWidth / 2, currentY, { align: 'center' });
        currentY += 20; // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡∏Å‡πà‡∏≠‡∏ô‡∏Å‡∏£‡∏≤‡∏ü
        console.log("9. Titles added to PDF.");

        // Add chart image - ‡∏õ‡∏£‡∏±‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á Y ‡∏Ç‡∏∂‡πâ‡∏ô‡∏°‡∏≤
        const imgProps = pdf.getImageProperties(imgData);
        const imgWidth = pdfWidth - 20;
        const imgHeight = imgProps.height * imgWidth / imgProps.width;
        pdf.addImage(imgData, 'PNG', 10, currentY, imgWidth, imgHeight);
        console.log("10. Chart image added to PDF.");

        // Add data table
        pdf.addPage();
        pdf.setFontSize(12);
        pdf.text(`‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡∏¥‡∏ö‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö ${serverDisplayName} ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ${monthName} ‡∏õ‡∏µ ${year}`, 10, 20);

        const tableHeaders = [['‡πÄ‡∏ß‡∏•‡∏≤', '‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥ (¬∞C)', '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô (%)']];
        const tableData = data.map(d => [
            d.time.toLocaleString('th-TH'),
            d.temp !== null ? d.temp.toFixed(1) : '-',
            d.hum !== null ? d.hum.toFixed(1) : '-'
        ]);

        pdf.autoTable({
            head: tableHeaders,
            body: tableData,
            startY: 30,
            margin: { top: 20, left: 10, right: 10 },
            headStyles: { fillColor: [124, 58, 237], textColor: [255, 255, 255], fontStyle: 'bold' },
            styles: {
                font: 'Noto Sans Thai Rounded',
                fontSize: 8,
                cellPadding: 2,
                overflow: 'linebreak'
            },
            columnStyles: {
                0: { cellWidth: 45 },
                1: { cellWidth: 25 },
                2: { cellWidth: 25 }
            },
        });
        console.log("11. Data table added to PDF.");

        pdf.save(`‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥-‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô-${serverDisplayName}-${monthName}-${year}.pdf`);
        console.log("12. PDF save initiated.");

    } catch (error) {
        console.error("Error during PDF export:", error);
    } finally {
        const tempDiv = document.getElementById('tempChartDiv');
        if (tempDiv && tempDiv.parentNode) {
            tempDiv.parentNode.removeChild(tempDiv);
            console.log("13. tempDiv removed in finally block.");
        }
    }
}
</script>

</body>
</html>
